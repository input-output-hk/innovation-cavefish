name: Haskell build and test

on:
  push:
    branches: [ "master", "release/**" ]
    paths:
      - 'cavefish-server/**'
      - '.github/workflows/cavefish-server-linux-ci.yml'

  pull_request:
    branches: [ "**" ]
    paths:
      - 'cavefish-server/**'
      - '.github/workflows/cavefish-server-linux-ci.yml'

jobs:
  build:
    name: GHC ${{ matrix.ghc-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        ghc-version: ['9.6.6']
      fail-fast: false
    env:
      CABAL_CACHE_VERSION: "2025-10-23"
      SECP256K1_REF: ac83be33d0956faf6b7f61a60ab524ef7d6a473a
      SECP_CACHE_VERSION: "2022-12-30"
      WBPS_TEST_INPUT_ROOT: ${{ github.workspace }}/cavefish-server/wbps/setup
      WBPS_TEST_OUTPUT_ROOT: ${{ github.workspace }}/cavefish-server/output/tests

    defaults:
      run:
        shell: bash

    steps:
      # ✅ Ensure LFS objects are fetched by the checkout itself
      - uses: actions/checkout@v4
        with:
          lfs: true          # <— pull LFS blobs (not just pointers)
          fetch-depth: 0     # <— needed if you pin to specific commits/tags

      # (Optional but safe) Install/initialize git-lfs explicitly and verify files
      - name: Initialize Git LFS and materialize files
        run: |
          git lfs install
          # Double-ensure all LFS objects are fetched & checked out
          git lfs fetch --all
          git lfs checkout
          # Quick sanity: show a few tracked files if present
          git lfs ls-files || true

      - name: Free up disk space
        run: |
          sudo rm -rf \
            "$AGENT_TOOLSDIRECTORY" \
            /opt/google/chrome \
            /opt/microsoft/msedge \
            /opt/microsoft/powershell \
            /opt/pipx \
            /usr/lib/mono \
            /usr/local/julia* \
            /usr/local/lib/android \
            /usr/local/lib/node_modules \
            /usr/local/share/chromium \
            /usr/local/share/powershell \
            /usr/share/dotnet \
            /usr/share/swift
          df -h /

      - name: Install system dependencies
        uses: input-output-hk/actions/base@latest
        with:
          use-sodium-vrf: false

      - name: Setup Node.js (for snarkjs)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust (for circom)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry (circom build)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cache/sccache
          key: cargo-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Build babyjubjub-keygen (native) and add to PATH
        run: |
          cargo install rust-script
          echo "Building and testing babyjubjub-keygen for $(uname -m) -> $DEST"
          "$GITHUB_WORKSPACE"/wbps/tooling/babyjubjub-keygen.rs
          echo "$GITHUB_WORKSPACE/cavefish-server/wbps/setup" >> "$GITHUB_PATH"

      - name: Install circom & snarkjs
        run: |
          cargo install --git https://github.com/iden3/circom --locked --force
          npm install -g snarkjs@^0.7.0
          circom --version
          snarkjs -v || true

      - name: Circomlib
        working-directory: ./wbps
        run: make deps-circomlib

      - name: Install Haskell
        id: install-haskell
        uses: input-output-hk/actions/haskell@latest
        with:
          ghc-version: ${{ matrix.ghc-version }}
          cabal-version: 3.12.1.0

      - name: Configure to use libsodium
        run: |
          cat >> cabal.project <<EOF
          package cardano-crypto-praos
            flags: -external-libsodium-vrf
          EOF

      - name: Cabal update
        working-directory: ./cavefish-server
        run: cabal update

      - name: Record dependencies to be used as cache keys
        working-directory: ./cavefish-server
        id: record-deps
        run: |
          cabal build all --enable-tests --dry-run --minimize-conflict-set
          cat dist-newstyle/cache/plan.json \
          | jq '.["install-plan"][].id' \
          | sort \
          | uniq \
          | tee dependencies.txt

      - name: Restore cache
        uses: actions/cache/restore@v4
        id: restore-cabal-cache
        env:
          cache-name: cache-cabal-build
        with:
          path: |
            ${{ steps.install-haskell.outputs.cabal-store }}
          key: ${{ env.cache-name }}-${{ runner.os }}-${{ matrix.ghc-version }}-${{ env.CABAL_CACHE_VERSION }}-${{ hashFiles('dependencies.txt') }}-${{ hashFiles('cabal.project*') }}
          restore-keys: |
            ${{ env.cache-name }}-${{ runner.os }}-${{ matrix.ghc-version }}-${{ env.CABAL_CACHE_VERSION }}-${{ hashFiles('dependencies.txt') }}
            ${{ env.cache-name }}-${{ runner.os }}-${{ matrix.ghc-version }}-${{ env.CABAL_CACHE_VERSION }}-

      - name: Check workflow test matrix
        working-directory: ./cavefish-server
        run: cabal build all --dry-run

      - name: Build dependencies
        working-directory: ./cavefish-server
        id: build-dependencies
        run: cabal build all --only-dependencies

      - name: Save cache
        uses: actions/cache/save@v4
        id: save-cabal-cache
        if: steps.build-dependencies.outcome == 'success' && steps.restore-cabal-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ steps.install-haskell.outputs.cabal-store }}
          key:  ${{ steps.restore-cabal-cache.outputs.cache-primary-key }}

      - name: Build
        working-directory: ./cavefish-server
        run: cabal build all

      - name: Test
        working-directory: ./cavefish-server
        run: cabal test all
